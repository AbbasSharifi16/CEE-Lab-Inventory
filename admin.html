<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CEE Lab Equipment Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .admin-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .admin-header h2 {
            color: #1e3c72;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-management {
            display: grid;
            gap: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 500;
            color: #333;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-admin {
            background: #e3f2fd;
            color: #1976d2;
        }

        .role-grant {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .role-faculty {
            background: #e8f5e8;
            color: #388e3c;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn.edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .action-btn.delete {
            background: #ffebee;
            color: #c62828;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .labs-list {
            font-size: 12px;
            color: #666;
        }

        .add-user-form {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2a5298;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff8f00 0%, #ffb300 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-actions .btn {
            min-width: 140px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .success-message,
        .error-message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .users-table {
                overflow-x: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* Edit Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 25px;
        }

        .edit-form {
            display: grid;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>
                    <img src="https://www.fiu.edu/_assets/images/fiu-white-logo.png" alt="FIU Logo" class="fiu-logo">
                    <span class="material-icons">biotech</span> 
                    CEE Lab Equipment Manager - Admin Panel
                </h1>
                <div class="header-actions">
                    <button onclick="window.location.href='/'" class="btn btn-secondary">
                        <span class="material-icons">arrow_back</span>
                        Back to Equipment
                    </button>
                    <button onclick="logout()" class="btn btn-secondary">
                        <span class="material-icons">logout</span>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="admin-panel">
                <div class="admin-header">
                    <h2>
                        <span class="material-icons">admin_panel_settings</span>
                        User Management
                    </h2>
                    <div class="admin-actions">
                        <button onclick="createBackupWithDirectoryChoice()" class="btn btn-secondary" title="Backup equipment list to JSON file">
                            <span class="material-icons">backup</span>
                            Backup Equipment
                        </button>
                        <button onclick="showRestoreModal()" class="btn btn-primary" title="Upload and restore equipment from JSON backup">
                            <span class="material-icons">restore</span>
                            Restore Backup
                        </button>
                        <button onclick="clearDatabase()" class="btn btn-warning" title="Clear all equipment data">
                            <span class="material-icons">clear_all</span>
                            Clear Database
                        </button>
                        <button onclick="clearAndRestore()" class="btn btn-danger" title="Clear database and restore from backup">
                            <span class="material-icons">refresh</span>
                            Clear & Restore
                        </button>
                    </div>
                </div>

                <div id="successMessage" class="success-message"></div>
                <div id="errorMessage" class="error-message"></div>

                <div class="user-management">
                    <!-- Add New User Section -->
                    <div class="add-user-section">
                        <div class="section-header">
                            <h3>
                                <span class="material-icons">person_add</span>
                                Add New User
                            </h3>
                        </div>
                        
                        <div class="add-user-form">
                            <form id="addUserForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstName">First Name *</label>
                                        <input type="text" id="firstName" name="firstName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="lastName">Last Name *</label>
                                        <input type="text" id="lastName" name="lastName" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="email">Email *</label>
                                        <input type="email" id="email" name="email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="pantherId">Panther ID *</label>
                                        <input type="text" id="pantherId" name="pantherId" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="phoneNumber">Phone Number</label>
                                        <input type="tel" id="phoneNumber" name="phoneNumber">
                                    </div>
                                    <div class="form-group">
                                        <label for="role">Role *</label>
                                        <select id="role" name="role" required>
                                            <option value="">Select Role</option>
                                            <option value="admin">Admin (Full Access)</option>
                                            <option value="grant">Grant User (Full Access)</option>
                                            <option value="faculty">Faculty Member (Limited Access)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group full-width" id="labsSection">
                                    <label>Authorized Labs *</label>
                                    <div class="checkbox-group">
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="all" id="allLabs">
                                            All Labs
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="EC3625" class="lab-checkbox">
                                            EC3625
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="EC3630" class="lab-checkbox">
                                            EC3630
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="EC3760" class="lab-checkbox">
                                            EC3760
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="EC3765" class="lab-checkbox">
                                            EC3765
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="OU107" class="lab-checkbox">
                                            OU107
                                        </label>
                                        <label>
                                            <input type="checkbox" name="authorizedLabs" value="OU106" class="lab-checkbox">
                                            OU106
                                        </label>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" id="resetForm" class="btn btn-secondary">
                                        <span class="material-icons">refresh</span>
                                        Reset Form
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <span class="material-icons">person_add</span>
                                        Add User & Send Invite
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Existing Users Section -->
                    <div class="existing-users-section">
                        <div class="section-header">
                            <h3>
                                <span class="material-icons">people</span>
                                Existing Users
                            </h3>
                            <button onclick="loadUsers()" class="btn btn-secondary">
                                <span class="material-icons">refresh</span>
                                Refresh
                            </button>
                        </div>
                        
                        <div class="users-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Authorized Labs</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Edit User Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons">edit</span>
                        Edit User
                    </h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="editSuccessMessage" class="success-message"></div>
                    <div id="editErrorMessage" class="error-message"></div>
                    
                    <form id="editUserForm" class="edit-form">
                        <input type="hidden" id="editUserId" name="userId">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFirstName">First Name *</label>
                                <input type="text" id="editFirstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="editLastName">Last Name *</label>
                                <input type="text" id="editLastName" name="lastName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editEmail">Email *</label>
                                <input type="email" id="editEmail" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="editPantherId">Panther ID *</label>
                                <input type="text" id="editPantherId" name="pantherId" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPhoneNumber">Phone Number</label>
                                <input type="tel" id="editPhoneNumber" name="phoneNumber">
                            </div>
                            <div class="form-group">
                                <label for="editRole">Role *</label>
                                <select id="editRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin (Full Access)</option>
                                    <option value="grant">Grant User (Full Access)</option>
                                    <option value="faculty">Faculty Member (Limited Access)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editStatus">Status *</label>
                                <select id="editStatus" name="status" required>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group full-width" id="editLabsSection">
                            <label>Authorized Labs *</label>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="all" id="editAllLabs">
                                    All Labs
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="EC3625" class="edit-lab-checkbox">
                                    EC3625
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="EC3630" class="edit-lab-checkbox">
                                    EC3630
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="EC3760" class="edit-lab-checkbox">
                                    EC3760
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="EC3765" class="edit-lab-checkbox">
                                    EC3765
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="OU107" class="edit-lab-checkbox">
                                    OU107
                                </label>
                                <label>
                                    <input type="checkbox" name="editAuthorizedLabs" value="OU106" class="edit-lab-checkbox">
                                    OU106
                                </label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="cancelEdit" class="btn btn-secondary">
                                <span class="material-icons">cancel</span>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons">save</span>
                                Update User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Restore Backup Modal -->
        <div id="restoreModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons">restore</span>
                        Restore Equipment Backup
                    </h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="restoreSuccessMessage" class="success-message"></div>
                    <div id="restoreErrorMessage" class="error-message"></div>
                    
                    <div class="restore-form">
                        <div class="form-group full-width">
                            <label for="backupFile">Select JSON Backup File *</label>
                            <input type="file" id="backupFile" accept=".json" required 
                                   style="padding: 10px; border: 2px dashed #e1e5e9; border-radius: 6px; background: #f8f9fa;">
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Choose a JSON backup file created by the backup feature
                            </small>
                        </div>

                        <div class="form-group full-width">
                            <label>
                                <input type="checkbox" id="clearBeforeRestore" style="margin-right: 8px;">
                                Clear existing equipment before restore
                            </label>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ⚠️ Warning: This will delete all current equipment data before importing
                            </small>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="cancelRestore" class="btn btn-secondary">
                                <span class="material-icons">cancel</span>
                                Cancel
                            </button>
                            <button type="button" onclick="uploadAndRestore()" class="btn btn-primary">
                                <span class="material-icons">restore</span>
                                Restore Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is admin
            checkAdminAccess();
            
            // Load existing users
            loadUsers();
            
            // Set up form handlers
            setupFormHandlers();
        });

        async function checkAdminAccess() {
            const token = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            
            if (!token || userRole !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '/';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userId');
                window.location.href = '/login.html';
            }
        }

        function setupFormHandlers() {
            const addUserForm = document.getElementById('addUserForm');
            const roleSelect = document.getElementById('role');
            const allLabsCheckbox = document.getElementById('allLabs');
            const labCheckboxes = document.querySelectorAll('.lab-checkbox');

            // Handle role change
            roleSelect.addEventListener('change', function() {
                const role = this.value;
                if (role === 'admin' || role === 'grant') {
                    allLabsCheckbox.checked = true;
                    allLabsCheckbox.disabled = true;
                    labCheckboxes.forEach(cb => {
                        cb.checked = true;
                        cb.disabled = true;
                    });
                } else {
                    allLabsCheckbox.disabled = false;
                    labCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });

            // Handle "All Labs" checkbox
            allLabsCheckbox.addEventListener('change', function() {
                labCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });

            // Handle individual lab checkboxes
            labCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    const allChecked = Array.from(labCheckboxes).every(checkbox => checkbox.checked);
                    allLabsCheckbox.checked = allChecked;
                });
            });

            // Handle form submission
            addUserForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await addUser();
            });

            // Handle reset form
            document.getElementById('resetForm').addEventListener('click', function() {
                addUserForm.reset();
                labCheckboxes.forEach(cb => {
                    cb.disabled = false;
                    cb.checked = false;
                });
                allLabsCheckbox.disabled = false;
                allLabsCheckbox.checked = false;
            });

            // Set up edit modal handlers
            setupEditModalHandlers();
        }

        function setupEditModalHandlers() {
            const modal = document.getElementById('editModal');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.getElementById('cancelEdit');
            const editForm = document.getElementById('editUserForm');

            // Close modal when clicking X or Cancel
            closeBtn.addEventListener('click', closeEditModal);
            cancelBtn.addEventListener('click', closeEditModal);

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeEditModal();
                }
            });

            // Handle form submission
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateUser();
            });
        }

        async function addUser() {
            const formData = new FormData(document.getElementById('addUserForm'));
            const authorizedLabs = Array.from(document.querySelectorAll('input[name="authorizedLabs"]:checked'))
                .map(cb => cb.value)
                .filter(value => value !== 'all');

            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                pantherId: formData.get('pantherId'),
                phoneNumber: formData.get('phoneNumber'),
                role: formData.get('role'),
                authorizedLabs: authorizedLabs
            };

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User added successfully! Invitation email sent.');
                    document.getElementById('addUserForm').reset();
                    document.querySelectorAll('.lab-checkbox').forEach(cb => {
                        cb.disabled = false;
                        cb.checked = false;
                    });
                    document.getElementById('allLabs').disabled = false;
                    document.getElementById('allLabs').checked = false;
                    loadUsers();
                } else {
                    showError(result.message || 'Failed to add user');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showError('Connection error. Please try again.');
            }
        }

        async function loadUsers() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const users = await response.json();

                if (response.ok) {
                    displayUsers(users);
                } else {
                    showError('Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Connection error while loading users');
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                const authorizedLabs = user.authorizedLabs ? user.authorizedLabs.split(',') : [];
                
                row.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                    <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                    <td class="labs-list">${authorizedLabs.join(', ')}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editUser(${user.id})" title="Edit User">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="action-btn delete" onclick="deleteUser(${user.id})" title="Delete User">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? They will need to be re-invited if you want to restore access.')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User deleted successfully');
                    loadUsers();
                } else {
                    showError(result.message || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Connection error. Please try again.');
            }
        }

        function editUser(userId) {
            // Open edit modal and load user data
            openEditModal(userId);
        }

        async function openEditModal(userId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const user = await response.json();

                if (response.ok) {
                    populateEditForm(user);
                    document.getElementById('editModal').style.display = 'block';
                } else {
                    showError(user.message || 'Failed to load user data');
                }
            } catch (error) {
                console.error('Error loading user for edit:', error);
                showError('Connection error while loading user data');
            }
        }

        function populateEditForm(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editFirstName').value = user.firstName;
            document.getElementById('editLastName').value = user.lastName;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPantherId').value = user.pantherId;
            document.getElementById('editPhoneNumber').value = user.phoneNumber || '';
            document.getElementById('editRole').value = user.role;
            document.getElementById('editStatus').value = user.status;

            // Handle authorized labs
            const authorizedLabs = user.authorizedLabs ? user.authorizedLabs.split(',') : [];
            const editLabCheckboxes = document.querySelectorAll('.edit-lab-checkbox');
            const editAllLabsCheckbox = document.getElementById('editAllLabs');

            // Clear all checkboxes first
            editLabCheckboxes.forEach(cb => cb.checked = false);
            editAllLabsCheckbox.checked = false;

            // Set authorized labs
            authorizedLabs.forEach(lab => {
                const checkbox = document.querySelector(`.edit-lab-checkbox[value="${lab}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            // Check if all labs are selected
            const allChecked = Array.from(editLabCheckboxes).every(cb => cb.checked);
            editAllLabsCheckbox.checked = allChecked;

            // Set up role-based restrictions
            setupEditRoleRestrictions();
        }

        function setupEditRoleRestrictions() {
            const editRoleSelect = document.getElementById('editRole');
            const editAllLabsCheckbox = document.getElementById('editAllLabs');
            const editLabCheckboxes = document.querySelectorAll('.edit-lab-checkbox');

            // Handle role change
            editRoleSelect.addEventListener('change', function() {
                const role = this.value;
                if (role === 'admin' || role === 'grant') {
                    editAllLabsCheckbox.checked = true;
                    editAllLabsCheckbox.disabled = true;
                    editLabCheckboxes.forEach(cb => {
                        cb.checked = true;
                        cb.disabled = true;
                    });
                } else {
                    editAllLabsCheckbox.disabled = false;
                    editLabCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });

            // Handle "All Labs" checkbox
            editAllLabsCheckbox.addEventListener('change', function() {
                editLabCheckboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });

            // Handle individual lab checkboxes
            editLabCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    const allChecked = Array.from(editLabCheckboxes).every(checkbox => checkbox.checked);
                    editAllLabsCheckbox.checked = allChecked;
                });
            });

            // Trigger role change to set initial state
            editRoleSelect.dispatchEvent(new Event('change'));
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editSuccessMessage').style.display = 'none';
            document.getElementById('editErrorMessage').style.display = 'none';
            
            // Remove event listeners to prevent duplicates
            const editRoleSelect = document.getElementById('editRole');
            const newEditRoleSelect = editRoleSelect.cloneNode(true);
            editRoleSelect.parentNode.replaceChild(newEditRoleSelect, editRoleSelect);
        }

        async function updateUser() {
            const formData = new FormData(document.getElementById('editUserForm'));
            const authorizedLabs = Array.from(document.querySelectorAll('input[name="editAuthorizedLabs"]:checked'))
                .map(cb => cb.value)
                .filter(value => value !== 'all');

            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                pantherId: formData.get('pantherId'),
                phoneNumber: formData.get('phoneNumber'),
                role: formData.get('role'),
                status: formData.get('status'),
                authorizedLabs: authorizedLabs
            };

            try {
                const token = localStorage.getItem('authToken');
                const userId = document.getElementById('editUserId').value;
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    showEditSuccess('User updated successfully!');
                    setTimeout(() => {
                        closeEditModal();
                        loadUsers();
                    }, 1500);
                } else {
                    showEditError(result.message || 'Failed to update user');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showEditError('Connection error. Please try again.');
            }
        }

        function showEditSuccess(message) {
            const successDiv = document.getElementById('editSuccessMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('editErrorMessage').style.display = 'none';
        }

        function showEditError(message) {
            const errorDiv = document.getElementById('editErrorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('editSuccessMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userId');
            window.location.href = '/login.html';
        }

        async function createBackup() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Show loading state
                const backupBtn = event.target.closest('button');
                const originalText = backupBtn.innerHTML;
                backupBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Creating Backup...';
                backupBtn.disabled = true;

                console.log('🔄 Starting equipment backup...');
                
                const response = await fetch('/api/admin/backup', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to create backup');
                }

                // Get the filename from the response headers
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'equipment_backup.json';
                
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                // Convert response to blob
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                
                // Trigger download
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success message
                showSuccess(`Backup created successfully! Downloaded as ${filename}`);
                console.log(`✅ Backup downloaded: ${filename}`);

            } catch (error) {
                console.error('Error creating backup:', error);
                showError('Failed to create backup. Please try again.');
            } finally {
                // Restore button state
                const backupBtn = document.querySelector('button[onclick="createBackupWithDirectoryChoice()"]');
                if (backupBtn) {
                    backupBtn.innerHTML = '<span class="material-icons">backup</span> Backup Equipment';
                    backupBtn.disabled = false;
                }
            }
        }

        // Alternative backup function that allows user to choose directory (using File System Access API)
        async function createBackupWithDirectoryChoice() {
            try {
                // Check if the browser supports the File System Access API
                if ('showDirectoryPicker' in window) {
                    // Let user choose directory
                    const directoryHandle = await window.showDirectoryPicker();
                    
                    const token = localStorage.getItem('authToken');
                    const response = await fetch('/api/admin/backup', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create backup');
                    }

                    const backupData = await response.text();
                    
                    // Create filename with timestamp
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `equipment_backup_${timestamp}.json`;
                    
                    // Create file in chosen directory
                    const fileHandle = await directoryHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(backupData);
                    await writable.close();

                    showSuccess(`Backup saved to chosen directory as ${filename}`);
                } else {
                    // Fallback to regular download
                    createBackup();
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled directory picker
                    return;
                }
                console.error('Error creating backup with directory choice:', error);
                showError('Failed to save backup to chosen directory. Using download instead.');
                createBackup();
            }
        }

        // Show restore modal
        function showRestoreModal() {
            const modal = document.getElementById('restoreModal');
            modal.style.display = 'block';
            
            // Clear any previous messages
            document.getElementById('restoreSuccessMessage').style.display = 'none';
            document.getElementById('restoreErrorMessage').style.display = 'none';
            
            // Reset form
            document.getElementById('backupFile').value = '';
            document.getElementById('clearBeforeRestore').checked = false;
        }

        // Upload and restore backup
        async function uploadAndRestore() {
            const fileInput = document.getElementById('backupFile');
            const clearBeforeRestore = document.getElementById('clearBeforeRestore').checked;
            
            if (!fileInput.files[0]) {
                showRestoreError('Please select a JSON backup file.');
                return;
            }

            const file = fileInput.files[0];
            
            // Validate file type
            if (!file.name.endsWith('.json') && file.type !== 'application/json') {
                showRestoreError('Please select a valid JSON file.');
                return;
            }

            try {
                // Read file content
                const fileContent = await file.text();
                let jsonData;
                
                try {
                    jsonData = JSON.parse(fileContent);
                } catch (parseError) {
                    showRestoreError('Invalid JSON file format. Please check your backup file.');
                    return;
                }

                // Show loading state
                const restoreBtn = document.querySelector('button[onclick="uploadAndRestore()"]');
                if (restoreBtn) {
                    const originalText = restoreBtn.innerHTML;
                    restoreBtn.innerHTML = '<span class="material-icons">hourglass_empty</span> Restoring...';
                    restoreBtn.disabled = true;
                }

                console.log('🔄 Starting equipment restore...');

                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/restore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        data: jsonData,
                        clearFirst: clearBeforeRestore
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || 'Failed to restore backup');
                }

                const result = await response.json();
                showRestoreSuccess(`Restore completed! ${result.imported} items imported successfully.`);
                
                // Close modal after short delay
                setTimeout(() => {
                    document.getElementById('restoreModal').style.display = 'none';
                }, 2000);
                
                console.log(`✅ Restore completed: ${result.imported} items imported`);

            } catch (error) {
                console.error('Error restoring backup:', error);
                showRestoreError('Failed to restore backup: ' + error.message);
            } finally {
                // Reset button state
                const restoreBtn = document.querySelector('button[onclick="uploadAndRestore()"]');
                if (restoreBtn) {
                    restoreBtn.innerHTML = '<span class="material-icons">restore</span> Restore Backup';
                    restoreBtn.disabled = false;
                }
            }
        }

        // Clear database
        async function clearDatabase() {
            if (!confirm('⚠️ WARNING: This will DELETE ALL equipment data!\n\nThis action cannot be undone. Are you sure you want to continue?')) {
                return;
            }

            if (!confirm('🔴 FINAL CONFIRMATION: All equipment will be permanently deleted.\n\nClick OK to proceed or Cancel to abort.')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/clear', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to clear database');
                }

                const result = await response.json();
                showSuccess(`Database cleared successfully! Removed ${result.deletedCount} equipment items.`);
                console.log(`✅ Database cleared: ${result.deletedCount} items removed`);

            } catch (error) {
                console.error('Error clearing database:', error);
                showError('Failed to clear database: ' + error.message);
            }
        }

        // Clear and restore
        function clearAndRestore() {
            if (!confirm('⚠️ WARNING: This will DELETE ALL current equipment and replace it with a backup!\n\nThis action cannot be undone. Are you sure?')) {
                return;
            }

            // Show restore modal with clear option pre-checked
            showRestoreModal();
            document.getElementById('clearBeforeRestore').checked = true;
            
            // Add visual indication that this is a clear & restore operation
            const modalHeader = document.querySelector('#restoreModal .modal-header h3');
            modalHeader.innerHTML = '<span class="material-icons">refresh</span> Clear & Restore Equipment';
        }

        // Helper functions for restore modal messages
        function showRestoreSuccess(message) {
            const successElement = document.getElementById('restoreSuccessMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            document.getElementById('restoreErrorMessage').style.display = 'none';
        }

        function showRestoreError(message) {
            const errorElement = document.getElementById('restoreErrorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('restoreSuccessMessage').style.display = 'none';
        }

        // Modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Restore modal close functionality
            const restoreModal = document.getElementById('restoreModal');
            const restoreCloseBtn = restoreModal.querySelector('.close');
            const cancelRestoreBtn = document.getElementById('cancelRestore');

            restoreCloseBtn.onclick = function() {
                restoreModal.style.display = 'none';
            }

            cancelRestoreBtn.onclick = function() {
                restoreModal.style.display = 'none';
            }

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target === restoreModal) {
                    restoreModal.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
